---
layout: posttoc
title: "静态博客目录生成方案选择"
subtitle: "简约不简单"
background: '/img/bg-tree.jpg'
published: false
imagefolder: ""
lastmodify: "2020-03-18"
tags: [搭建博客, TOC]
---

文章有目录才方便阅读，我想要的效果是目录悬浮在右侧并且高亮当前的导航目录，这样的目录才算有用。

看着挺简单但其实需要考虑的因素不少，下面分两个部分评估一下。前半部考虑如何生成目录，后半部考虑如何应用JavaScript自动高亮。

### 生成目录 {#toc-generate}

我们先考虑下如何生成目录。

#### Markdown内建目录 {#markdown-builtin-toc}

```
* toc
{:toc}
```
Markdown语法生成的TOC元素和结构是`<ul id="markdown-toc"><li><a id="markdown-toc-xxx">`，这就有几个问题：

1. 静态网站比如Jekyll，只有文章的正文是Markdown格式，其他公用部分是放在Layouts的，这就造成了几个问题：
   - 每一个.md文件都需要加这一行，尽管很少
   - TOC只能放在正文里并且位置固定，这样的目录意义不大。如果能放在正文两侧并且是`position:sticky`的效果还可以接受。尝试了下，没有成功:sweat_smile:
   - 后期维护困难，如果想调整每一个.md文件都要修改:scream:
2. 无法指定CSS class，应用CSS就要困难些。

如果标题包含多语言，有个情况是目录里的链接会被URI编码，这就会造成一些的JS库无法工作。这个事情要各打五十大板，为什么这么说呢？

Markdown编码干啥捏（可能是遵循标准）？就直接多语言字符输出，我们点链接的时候人浏览器知道编码！

JS库没考虑周全吧，`jQuery("#markdown%E5%86%85...")`人jQuery要报错啊！用属性选择器就没问题`jQuery("[id='markdown%E5%86%85...']")`

出局！

#### Jekyll Pure Liquid TOC

{% include outerlink.html link="https://github.com/allejo/jekyll-toc" %} 静态目录生成方案，也就是说目录随着文章内容一起生成静态文件。

Liquid是一种模板语言，Jekyll用它来处理模板，和Velocity、FreeMarker差不多。Jekyll的默认Markdown渲染器是[kramdown](https://kramdown.gettalong.org/index.html){:target="_blank"}，它是标准Markdown的扩展集，也就是说兼容Markdown并且提供更加丰富的语法来锦上添花。

想想真是不错，标准语法不影响书写流畅度，额外语法解决一些棘手问题，确实就很顺手了:yum:

这个方案的思路是用Liquid抓取Header来生成Markdown无序列表，然后通过kramdown指定元素CSS。

提供很多配置参数，高度可定制。支持设置`<ul><li><a>`三个元素的CSS class，但kramdown只能应用class到顶级`<ul>`，和JavaScript库合作的话就会有一些问题。

生成的kramdown目录就像这样：

`- {:.li-class} [Jump4](#jump4){:.a-class}`

#### Jekyll Table of Contents

{% include outerlink.html link="https://github.com/ghiculescu/jekyll-table-of-contents" %} 纯JS目录生成器，这是动态生成方案，也就是说当浏览器打开文章的时候目录才动态生成。

除了生成目录，它还给每个Header加上`<i>`标签，点击后滚动到顶部，我感觉没什么用处。有个配置可以关闭该功能。

既然是JS就会有些显示效果，比如淡入，滑下等。可以配置`<ul>/<ol>`和`<li>`的CSS class，但暂时不支持指定`<a>`的CSS class，所以和[Scrollspy](#bootstrap-scrollspy)合作失败。可以增加个配置。

#### TOC Markdown Generator

{% include outerlink.html link="https://github.com/dafi/tocmd-generator" %} 这个是在正文的前面插入目录，而且只能抓取`<h1><h2>`或`<h2><h3>`来生成目录。

功能有限，限制颇多，出局！

### 自动高亮 {#toc-highlight}

这个效果只有依靠JavaScript来实现。

#### jQuery One Page Nav

{% include outerlink.html link="https://github.com/davist11/jQuery-One-Page-Nav" %} 这个插件只管应用JS效果，你得自己准备目录内容。主要功能包括：

- 点击导航条目的时候平滑滚动
- 浏览的时候自动高亮当前导航条目

由于上面提到的原因，如果目录包含多语言，功能将失效。可以通过指定Header的`id`属性来解决，kramdown提供语法支持。

#### Bootstrap Scrollspy

{% include outerlink.html link="https://getbootstrap.com/docs/4.3/components/scrollspy/" %} Bootstrap现成组件，提供JS和CSS，开箱即用。

只提供自动高亮当前导航目录的功能，有个亮点是如果子目录高亮，父目录也会同时高亮。但如果有三级目录，浏览到第三级的时候，高亮的目录会连成一片，就有点儿喧宾夺主的感觉。

同样的，还是自己准备目录内容。一样无法高亮多语言目录，解决方法同上。

### 方案选择 {#solution-select}

[Liquid](#jekyll-pure-liquid-toc)方案如果不需要高亮效果还是不错的。

#### Extra4 TODO

标签云加了个配置`background: true | false`，应用颜色深浅到文字还是背景色，提交了Pull Request

*[TOC]:Table of Contents

{% comment %}

Liquid + One Page Nav: kramdown只能应用CSS到第一级<ul>，One Page Nav调整些CSS
Liquid + Scrollspy: kramdown只能应用CSS到第一级<ul>，歪打正着没有了高亮父目录，目录不乱跳，Liquid就没啥Bug。内嵌<ul>有显示问题，需要不少CSS调整

toc + One Page Nav: 高亮应用在<li>上，修改只应用到第一个<a>，调整背景(#F5F5F5)，前景(#bfbfbf)，少量CSS调整，基本完美了
toc + Scrollspy: CSS应用完美，功能完全/需要能配置<a> class，<ul>加margin-left=1em解决缩进问题而不用关心是第几级，调整背景前景色

////
function generateCatalog (selector) {
var P = $('div.post-container'),a,n,t,l,i,c;
a = P.find('h1,h2,h3,h4,h5,h6');
a.each(function () {
n = $(this).prop('tagName').toLowerCase();
i = "#"+$(this).prop('id');
t = $(this).text();
c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
l = $('<li class="'+n+'_nav"></li>').append(c);
$(selector).append(l);
});
return true; 
}

generateCatalog(".catalog-body");
////
https://allejo.io/blog/a-jekyll-toc-without-plugins-or-javascript/
https://ouyi.github.io/post/2017/12/31/jekyll-table-of-contents.html
{% endcomment %}